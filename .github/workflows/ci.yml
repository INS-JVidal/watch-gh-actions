name: CI

on:
  push:
    branches: [master]

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo test
      - run: cargo clippy -- -D warnings

  bump-minor:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Bump minor version
        run: |
          current=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          major=$(echo "$current" | cut -d. -f1)
          minor=$(echo "$current" | cut -d. -f2)
          new_minor=$((minor + 1))
          new_version="$major.$new_minor.0"
          sed -i "s/^version = \"$current\"/version = \"$new_version\"/" Cargo.toml
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Cargo.toml
          git commit -m "chore: bump minor to $new_version [skip ci]"
          git push

  cleanup:
    needs: bump-minor
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Delete workflow runs older than 7 days
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
        run: |
          gh run list --limit 100 --json databaseId,createdAt \
            --jq '[.[] | select(.createdAt < (now - 7*24*3600 | strftime("%Y-%m-%dT%H:%M:%SZ")))] | .[].databaseId' \
          | xargs -I{} gh run delete {} || true
